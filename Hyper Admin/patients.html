<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="styles.css" rel="stylesheet" />
  <style>
    .table-actions button { margin-right: 5px; }
  </style>
</head>
<body>
  <div class="content-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <a href="dashboard.html" class="btn btn-outline-secondary back-btn">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
      <h2 class="mb-0">Patient Management</h2>
      <div></div>
    </div>

    <div class="mb-3 d-flex justify-content-between flex-wrap gap-3">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Search by Patient Name, ID or Phone"
        autocomplete="off"
      />
      <button id="exportCsvBtn" class="btn btn-primary">
        <i class="fas fa-file-csv"></i> Export Patient List (CSV)
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Patient ID</th>
            <th>Name</th>
            <th>Date of Birth</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Registered At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="patientTableBody"></tbody>
      </table>
    </div>

    <nav aria-label="Patient list pagination">
      <ul class="pagination" id="pagination"></ul>
    </nav>
  </div>

  <!-- Edit Patient Modal -->
  <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="editPatientForm" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="editPatientModalLabel">Edit Patient</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editPatientIndex">
          <div class="mb-3">
            <label for="editPatientName" class="form-label">Name</label>
            <input type="text" class="form-control" id="editPatientName" required>
          </div>
          <div class="mb-3">
            <label for="editPatientDOB" class="form-label">Date of Birth</label>
            <input type="date" class="form-control" id="editPatientDOB">
          </div>
          <div class="mb-3">
            <label for="editPatientGender" class="form-label">Gender</label>
            <select class="form-select" id="editPatientGender">
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editPatientPhone" class="form-label">Phone</label>
            <input type="text" class="form-control" id="editPatientPhone">
          </div>
          <div class="mb-3">
            <label for="editPatientEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editPatientEmail">
          </div>
          <div class="mb-3">
            <label for="editPatientAddress" class="form-label">Address</label>
            <input type="text" class="form-control" id="editPatientAddress">
          </div>
          <div class="mb-3">
            <label for="editPatientComplaint" class="form-label">Medical Complaint</label>
            <input type="text" class="form-control" id="editPatientComplaint">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function getPatients() {
      return JSON.parse(localStorage.getItem('patients') || '[]');
    }
    function savePatients(patients) {
      localStorage.setItem('patients', JSON.stringify(patients));
    }

    function renderPatientTable(patients) {
      const tbody = document.getElementById('patientTableBody');
      tbody.innerHTML = '';
      patients.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${p.patientId || ''}</td>
          <td>${p.name || ''}</td>
          <td>${p.dob || ''}</td>
          <td>${p.gender || ''}</td>
          <td>${p.phone || ''}</td>
          <td>${p.email || ''}</td>
          <td>${p.registeredAt ? new Date(p.registeredAt).toLocaleString() : ''}</td>
          <td class="table-actions">
            <button type="button" class="btn btn-sm btn-outline-primary edit-patient-btn" data-index="${idx}" title="Edit">
              <i class="fas fa-pen"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger delete-patient-btn" data-index="${idx}" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filter function for search
    function filterPatients(query) {
      const val = (query || "").toLowerCase();
      return getPatients().filter(p =>
        (p.name || '').toLowerCase().includes(val) ||
        (p.patientId || '').toLowerCase().includes(val) ||
        (p.phone || '').toLowerCase().includes(val)
      );
    }

    document.addEventListener('DOMContentLoaded', function () {
      renderPatientTable(getPatients());

      // Search
      document.getElementById('searchInput').addEventListener('input', function () {
        renderPatientTable(filterPatients(this.value));
      });

      // Export CSV
      document.getElementById('exportCsvBtn').addEventListener('click', function () {
        const data = getPatients();
        if (!data.length) return alert('No patients found!');
        const keys = ["patientId","name","dob","gender","phone","email","address","registeredAt"];
        const rows = [
          keys.join(","), // header
          ...data.map(p => keys.map(k => `"${(p[k] || "").replace(/"/g, '""')}"`).join(","))
        ];
        const csv = rows.join("\n");
        const a = document.createElement('a');
        a.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
        a.download = "patients.csv";
        a.click();
      });

      // Table action button handlers (edit & delete)
      document.getElementById('patientTableBody').addEventListener('click', function (e) {
        const editBtn = e.target.closest('.edit-patient-btn');
        if (editBtn) {
          const idx = editBtn.getAttribute('data-index');
          const p = getPatients()[idx];
          if (!p) return;
          document.getElementById('editPatientIndex').value = idx;
          document.getElementById('editPatientName').value = p.name || '';
          document.getElementById('editPatientDOB').value = p.dob || '';
          document.getElementById('editPatientGender').value = p.gender || '';
          document.getElementById('editPatientPhone').value = p.phone || '';
          document.getElementById('editPatientEmail').value = p.email || '';
          document.getElementById('editPatientAddress').value = p.address || '';
          document.getElementById('editPatientComplaint').value = p.complaint || p.medicalHistory || '';
          new bootstrap.Modal(document.getElementById('editPatientModal')).show();
        }

        const delBtn = e.target.closest('.delete-patient-btn');
        if (delBtn) {
          const idx = delBtn.getAttribute('data-index');
          const patients = getPatients();
          if (!patients[idx]) return;
          if (confirm('Delete this patient? This cannot be undone.')) {
            patients.splice(idx,1);
            savePatients(patients);
            renderPatientTable(filterPatients(document.getElementById('searchInput').value));
          }
        }
      });

      // Edit save handler
      document.getElementById('editPatientForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const idx = document.getElementById('editPatientIndex').value;
        const patients = getPatients();
        if (!patients[idx]) return;
        patients[idx].name = document.getElementById('editPatientName').value.trim();
        patients[idx].dob = document.getElementById('editPatientDOB').value;
        patients[idx].gender = document.getElementById('editPatientGender').value;
        patients[idx].phone = document.getElementById('editPatientPhone').value.trim();
        patients[idx].email = document.getElementById('editPatientEmail').value.trim();
        patients[idx].address = document.getElementById('editPatientAddress').value.trim();
        patients[idx].complaint = document.getElementById('editPatientComplaint').value.trim();
        savePatients(patients);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('editPatientModal')).hide();
        renderPatientTable(filterPatients(document.getElementById('searchInput').value));
      });
    });
  </script>
</body>
</html>