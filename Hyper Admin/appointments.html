<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Appointments Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="styles.css" rel="stylesheet"/>
  <style>
    body { background: #f7fafe; }
    .back-btn { margin-bottom: 18px; }
    .content-wrap { max-width: 1080px; margin: auto; }
    h2 { letter-spacing: 0.5px; }
    .table-actions .btn { margin-right: 6px; }
    .table-striped>tbody>tr:nth-of-type(odd)>* { background: #f8fafe !important; }
    .table-hover>tbody>tr:hover>td, 
    .table-hover>tbody>tr:hover>th { background: #e6f0fa !important; }
    .modal .form-label { font-weight: 500; }
    .modal-title { color: #184983; letter-spacing: .5px; }
    .badge {
      font-size: 0.93em;
      letter-spacing: 0.02em;
      padding: 0.5em 0.9em;
      border-radius: 14px;
    }
  </style>
</head>
<body>
  <div class="content-wrap py-4">
    <div class="d-flex justify-content-start align-items-center mb-4">
      <a href="dashboard.html" class="btn btn-outline-secondary me-3 back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
      <h2 class="mb-0 flex-grow-1 text-center w-100">Appointments</h2>
    </div>

    <!-- Appointments Table -->
    <div class="table-responsive mt-3">
      <table class="table table-striped table-hover align-middle shadow rounded">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Patient</th>
            <th>Patient ID</th>
            <th>Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="appointmentsTable"></tbody>
      </table>
    </div>

    <!-- Modal: Assign/Edit Doctor -->
    <div class="modal fade" id="assignDoctorModal" tabindex="-1" aria-labelledby="assignDoctorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="assignDoctorForm" autocomplete="off">
          <div class="modal-header">
            <h5 class="modal-title" id="assignDoctorModalLabel">Assign or Edit Doctor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pb-2">
            <input type="hidden" id="editingIdx"/>
            <div class="mb-3">
              <label class="form-label">Patient</label>
              <input class="form-control" id="assignPatientName" disabled/>
            </div>
            <div class="mb-3">
              <label for="assignDoctor" class="form-label">Select Doctor <span class="text-danger">*</span></label>
              <select class="form-select" id="assignDoctor" required>
                <!-- Options loaded dynamically -->
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (() => {
      function getPatients() {
        return JSON.parse(localStorage.getItem('patients') || '[]');
      }
      function getAppointments() {
        return JSON.parse(localStorage.getItem('appointments') || '[]');
      }
      function setAppointments(appts) {
        localStorage.setItem('appointments', JSON.stringify(appts));
      }
      function getUsers() {
        return JSON.parse(localStorage.getItem('users') || '[]');
      }

      // Fetch active doctors from users
      function getDoctorsList() {
        return getUsers().filter(u =>
          (u.role === "Doctor" || u.role === "Doctor/Physio") &&
          (u.status === "Active" || !u.status) && u.name);
      }
      function populateDoctorDropdown(selected) {
        const select = document.getElementById('assignDoctor');
        const doctors = getDoctorsList();
        select.innerHTML = '<option value="">-- Select Doctor --</option>' +
          doctors.map(doc => `<option value="${doc.name}">${doc.name}</option>`).join('');
        if (selected) select.value = selected;
      }

      // Render appointments 
      function renderTable() {
        const patients = getPatients();
        const appts = getAppointments();
        const patMap = {};
        patients.forEach(p => patMap[p.patientId] = p);
        const tbody = document.getElementById('appointmentsTable');
        tbody.innerHTML = '';
        if (!appts.length) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No Appointments Found</td></tr>`;
          return;
        }
        appts.forEach((a, idx) => {
          let badge = 'bg-secondary';
          if (a.status === 'pending') badge = 'bg-warning text-dark';
          else if (a.status === 'completed') badge = 'bg-success';
          else if (a.status === 'ongoing') badge = 'bg-info';
          else if (a.status === 'cancelled') badge = 'bg-danger';
          let patient = patMap[a.patientId] || {};
          let patName = a.patient || patient.name || a.patientId || 'N/A';
          let doctor = a.doctor || '';
          tbody.innerHTML += `
            <tr>
              <td>${idx + 1}</td>
              <td>${patName}</td>
              <td>${a.patientId || ''}</td>
              <td>${doctor}</td>
              <td>${a.date || ''}</td>
              <td>${a.time || ''}</td>
              <td><span class="badge ${badge}">${a.status ? a.status.charAt(0).toUpperCase() + a.status.slice(1) : ''}</span></td>
              <td class="table-actions">
                <button class="btn btn-sm btn-outline-primary edit-btn" data-idx="${idx}" title="Assign/Edit Doctor">
                  <i class="fas fa-pen"></i>
                </button>
              </td>
            </tr>
          `;
        });
        attachEditHandler();
      }

      let editingIdx = null;
      function attachEditHandler() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.onclick = function() {
            editingIdx = +btn.getAttribute('data-idx');
            const appts = getAppointments();
            const a = appts[editingIdx];
            const p = getPatients().find(pp => pp.patientId === a.patientId) || {};
            document.getElementById('assignPatientName').value = p.name || a.patient || a.patientId || 'N/A';
            populateDoctorDropdown(a.doctor || '');
            document.getElementById('editingIdx').value = editingIdx;
            new bootstrap.Modal(document.getElementById('assignDoctorModal')).show();
          };
        });
      }

      document.getElementById('assignDoctorForm').onsubmit = function (e) {
        e.preventDefault();
        const idx = document.getElementById('editingIdx').value;
        let appts = getAppointments();
        if (!appts[idx]) return;
        const doctor = document.getElementById('assignDoctor').value;
        if (!doctor) {
          document.getElementById('assignDoctor').focus();
          return alert('Please select a doctor');
        }
        appts[idx].doctor = doctor;
        if (!appts[idx].status || appts[idx].status === 'pending')
          appts[idx].status = 'ongoing';
        setAppointments(appts);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('assignDoctorModal')).hide();
        renderTable();
      };

      // Initial Render
      renderTable();
    })();
  </script>
</body>
</html>