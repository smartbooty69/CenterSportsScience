<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Physio Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    .dashboard-section {
      margin-left: 250px;
      padding: 20px 40px 40px;
    }
    .sidebar {
      width: 250px;
      position: fixed;
      height: 100vh;
      background-color: #343a40;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .nav-link {
      color: white;
      transition: background 0.2s;
    }
    .nav-link:hover,
    .nav-link.active {
      background-color: #495057;
      color: white;
    }
    .logout-btn {
      color: #dc3545 !important;
      background: none;
      border: none;
      padding-left: 0;
      padding-right: 0;
      text-align: left;
      width: 100%;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }
    .logout-btn:hover {
      background: #b72d36 !important;
      color: #fff !important;
    }
    #calendar {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 3px 14px rgba(0, 0, 0, 0.08);
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="sidebar p-3">
      <h4 class="text-center mb-4">Centre</h4>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a href="physio-dashboard.html" class="nav-link active">
            <i class="fas fa-stethoscope me-2"></i>Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="edit-report.html" class="nav-link">
            <i class="fas fa-file-medical me-2"></i>View/Edit Report
          </a>
        </li>
        <li class="nav-item">
          <a href="transfer-patients.html" class="nav-link">
            <i class="fas fa-file-medical me-2"></i>Transfer Patients
          </a>
        </li>
        <li class="nav-item">
          <button class="nav-link logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
          </button>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="dashboard-section container-fluid">
      <h3 class="mb-4">Welcome, <span id="physioNameDisplay"></span></h3>
      <!-- Patient Statistics -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card border-warning">
            <div class="card-body text-center">
              <h5>Pending Patients</h5>
              <p class="fs-4" id="pendingCount">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-info">
            <div class="card-body text-center">
              <h5>Ongoing Patients</h5>
              <p class="fs-4" id="ongoingCount">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-success">
            <div class="card-body text-center">
              <h5>Completed Patients</h5>
              <p class="fs-4" id="completedCount">0</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-5">
          <div class="mb-3">
            <h5>Pending Patients</h5>
            <ul class="list-group mb-4" id="pendingList"></ul>
          </div>
          <div class="mb-3">
            <h5>Ongoing Patients (Click to fill treatment plan)</h5>
            <ul class="list-group mb-4" id="ongoingList"></ul>
          </div>
          <div class="mb-3">
            <h5>Completed Patients</h5>
            <ul class="list-group" id="completedList"></ul>
          </div>
        </div>
        <div class="col-lg-7">
          <h5>Upcoming Appointments Calendar</h5>
          <div id="calendar"></div>
        </div>
      </div>

      <!-- Monthly Earnings Chart -->
      <div class="card mt-5">
        <div class="card-header bg-success text-white">Monthly Earnings</div>
        <div class="card-body">
          <canvas id="physioEarningsChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS & FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script>
    // Logout handler
    document.getElementById("logoutBtn").onclick = function() {
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    };

    // Dashboard script
    (function () {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      const physioName = currentUser.name || 'Dr. Arun';
      document.getElementById('physioNameDisplay').textContent = physioName;

      let patients = JSON.parse(localStorage.getItem('patients')) || [];
      let appointments = JSON.parse(localStorage.getItem('appointments')) || [];

      const pendingList = document.getElementById('pendingList');
      const ongoingList = document.getElementById('ongoingList');
      const completedList = document.getElementById('completedList');

      const pendingCountEl = document.getElementById('pendingCount');
      const ongoingCountEl = document.getElementById('ongoingCount');
      const completedCountEl = document.getElementById('completedCount');

      // Render patients with edit buttons
      function renderPatients() {
        pendingList.innerHTML = '';
        ongoingList.innerHTML = '';
        completedList.innerHTML = '';

        let pendingCount = 0, ongoingCount = 0, completedCount = 0;

        const filteredPatients = patients.filter(p => p.assignedDoctor === physioName);

        filteredPatients.forEach((p) => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';

          const span = document.createElement('span');
          span.textContent = p.name;

          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-sm btn-outline-primary';
          editBtn.textContent = 'Edit Report';
          editBtn.addEventListener('click', () => {
            window.location.href = `edit-report.html?patientId=${encodeURIComponent(p.patientId)}`;
          });

          li.appendChild(span);
          li.appendChild(editBtn);

          if (p.status === 'pending') {
            pendingList.appendChild(li);
            pendingCount++;
          } else if (p.status === 'ongoing') {
            ongoingList.appendChild(li);
            ongoingCount++;
          } else if (p.status === 'completed') {
            completedList.appendChild(li);
            completedCount++;
          } else {
            // Default to pending
            pendingList.appendChild(li);
            pendingCount++;
          }
        });

        pendingCountEl.textContent = pendingCount;
        ongoingCountEl.textContent = ongoingCount;
        completedCountEl.textContent = completedCount;
      }

      function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        const physioPatientIds = patients.filter(p => p.assignedDoctor === physioName).map(p => p.patientId);
        const filteredAppointments = appointments.filter(a => physioPatientIds.includes(a.patientId));

        const events = filteredAppointments.map(a => ({
          id: a.patientId,
          title: a.patient,
          start: a.date,
          extendedProps: { ...a }
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events: events,
          eventClick(info) {
            info.jsEvent.preventDefault();
            const pid = info.event.extendedProps.patientId;
            if (pid) {
              window.location.href = `edit-report.html?patientId=${encodeURIComponent(pid)}`;
            }
          }
        });
        calendar.render();
      }

      renderPatients();
      renderCalendar();

      // You could add earnings chart code here if needed

    })();
  </script>
</body>
</html>
